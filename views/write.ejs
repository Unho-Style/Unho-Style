<style>
    .root {
        padding: 25px;
    }

    label {
        font-size: 1.3em;
    }

    #editor {
        width: 100%;
        height: 15em;
    }

    #imgUpload {
        width: 100%;
        margin-left: 1px;
        height: 10em;
    }

    #imgUpload > div.col-md-3 {
        padding: 0;
        margin-right: 10px;
        height: 10em;
        width: 10em;
    }

    #file {
        visibility: hidden;
    }

    .fileCnt {
        margin: 0;
        padding: 0;
    }

    .disable {
        color: gray;
    }

    .cardImg {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -o-user-select: none;
        user-select: none;
        cursor: pointer;
        position: relative;
        height: 10em;
        width: 10em;
        margin-top: -35px;
        z-index: -1;
        object-fit: cover;
    }

    .imgCard {
        position: relative;
    }

    .thumbnail {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -o-user-select: none;
        user-select: none;
        height: 25px;
        line-height: 25px;
        font-size: 14px;
        text-align: center;
        display:inline-block;
        margin: 5px;
        padding: 0px 5px 0px 5px;
        border-radius: 5px;
        z-index: 99;
        color:white;
        background-color: rgba(0,0,0,0.5);
    }

    .closeBtnBG {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -o-user-select: none;
        user-select: none;
        margin-right: 5px;
        margin-top: 5px;
        float: right;
        z-index: 99;
        height: 25px;
        width: 25px;
        border-radius: 50%;
        background-color: rgba(0,0,0,0.5);
    }

    .closeBtn {
        display:block;
        line-height: 25px;
        text-align: center;
        color: white;
        text-decoration: none;
    }

    #addImg {
        background-color: rgb(238, 238, 238);
        display:flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -o-user-select: none;
        user-select: none;
    }
</style>
<!-- <script>let editor;</script> -->

<script>
let uploadFile = [];
let id = 0;
</script>
<%- include('nav', {username: username}) %>
<div class="root">
    <form action="javascript:upload();">
        <div class="mb-3">
            <label class="form-label">상품 이미지</label>
            <input type="file" accept="image/*" id="file" multiple required>
            <p class="fileCnt">0/10</p>
            <div class="row overflow-x-auto overflow-y-hidden flex-nowrap" id="imgUpload">
                <div class="col-md-3" id="addImg">
                    <div style="text-align: center;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 24 24"><path d="M19 2c1.654 0 3 1.346 3 3v14c0 1.654-1.346 3-3 3h-14c-1.654 0-3-1.346-3-3v-14c0-1.654 1.346-3 3-3h14zm0-2h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-7 6c-3.313 0-6 2.687-6 6s2.687 6 6 6 6-2.687 6-6-2.687-6-6-6zm0 10c-2.206 0-4-1.794-4-4s1.794-4 4-4c2.205 0 4 1.794 4 4s-1.795 4-4 4zm7-10c-.553 0-1-.448-1-1s.447-1 1-1 1 .448 1 1-.447 1-1 1z"/></svg>
                        <p>이미지 추가</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">제목</label>
            <input type="text" class="form-control" id="title">
        </div>
        <div class="mb-3">
            <label class="form-label">상품 종류</label>
            <select id="category" class="form-select">
                <option value="0">디지털</option>
                <option value="1">문구</option>
                <option value="2">도서</option>
                <option value="3">의류</option>
                <option value="4">취미/게임/음반</option>
                <option value="5">기타</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">가격</label>
            <div class="input-group mb-3">
                <input type="number" class="form-control" id="price">
                <span class="input-group-text" id="basic-addon2">원</span>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">설명</label>
            <textarea id="editor" class="form-control" placeholder="구매시기, 브랜드/모델명, 상품 상태등을 자세히 적어주세요."></textarea>
        </div>
        <button type="submit" class="btn btn-primary upload">업로드</button>
    </form>
</div>

<script>
// ClassicEditor
//     .create( document.querySelector( '#editor' ), {
//         simpleUpload: {
//             uploadUrl: '/api/fileupload',
//             withCredentials: true
//         }
//     }).then(newEditor => {
//         window.editor = newEditor;
//     })
//     .catch( error => {
//         console.error( error );
//     } );

$(document).on('click', '#addImg', () => {
    if(uploadFile.length > 10) {
        alert('사진 첨부 가능 개수는 최대 10개 입니다.');
        return;
    }
    $('input#file').click();
});
$(document).on('change', 'input#file', fileUploaded);
$(document).on('click', 'a.closeBtn', removeFile);

async function fileUploaded(img) {
    const files = img.currentTarget?.files;
    // console.log(img);
    // console.log(files);
    if(!!files) {
        let totalCnt = uploadFile.length + files.length;
        if(totalCnt > 10) {
            alert('사진 첨부 가능 개수는 최대 10개 입니다.');
            return;
        }
        $('p.fileCnt').text(`${totalCnt}/10`);
        for(let i = 0; i < files.length; i++) {
            let e = files[i];
            let dataURL = await readAsDataURL(e)
            let card = `<div class="col-md-3 imgCard" data-img-id="${id}">
                <div class="thumbnail" style="display: ${uploadFile.length == 0 ? "inline-block" : "none"}"><span>대표이미지</span></div>
                <div class="closeBtnBG">
                    <a href="#" class="closeBtn" data-img-id="${id}">&#x2715;</a>
                </div>
                <img class="cardImg" src="${dataURL}">
            </div>`
            uploadFile.push({id: id, isThumbnail: uploadFile.length == 0, file: e});
            id++;
            $('#imgUpload').append(card);
        }
    }
}

function readAsDataURL(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;

        reader.readAsDataURL(blob)
    });
}

function removeFile(e) {
    let targetId = $(e.target).attr('data-img-id');
    let idx = uploadFile.findIndex(e => e.id == targetId);
    uploadFile.splice(idx, 1);
    $('div.imgCard[data-img-id="' + targetId + '"]').remove();
    $('p.fileCnt').text(`${uploadFile.length}/10`);
    if(!!!uploadFile[0]?.isThumbnail) {
        if(uploadFile[0]?.isThumbnail === undefined) return;
        uploadFile[0].isThumbnail = true;
        $($('div.imgCard > div.thumbnail')[0]).attr('style', 'display: inline-block;');
    }
}

function upload() {
    let title = $('input#title').val();
    let price = $('input#price').val();
    let body  = $('textarea#editor').val();
    // let body = window.editor.getData();
    console.log(title, price, body)
    if(!!!title) {
        return;
    }
    if(!!!body) {
        return;
    }

    //TODO: upload product
    new Promise(async (res, rej) => {
        // 파일 업로드
        let fileURL = [];
        for(let i = 0; i < uploadFile.length; i++) {
            var data = new FormData()
            data.append('file', uploadFile[i].file)
            let res = await (await fetch('/api/fileupload', {
                method: 'POST',
                headers: {
                    'Content-Type': 'multipart/form-data'
                },
                body: data
            })).json();
            fileURL.push(res.url);
        }

        let productID = await (await fetch('/api/trades/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                'title': title,
                'price': price,
                'body': body,
                'images': fileURL
            })
        })).json();

        window.location.href = '/product/' + productID;
    })
}
</script>